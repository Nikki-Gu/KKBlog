---
title: 内存管理和文件系统
order: 7

copyright: <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0协议</a>
---

## 内存管理

### 定义

一般内存管理就是指操作系统的内存分配策略

- 内存分配和回收：给进程分配需要的内存，进程结束后回收内存资源
  - 内存分配策略
  - 内存回收算法
- 地址转换：虚拟内存地址转为物理内存地址
  - 映射
  - 保证进程之间内存使用互不干扰

### 内存分配策略

- 连续内存管理：进程使用的内存空间连续
  - 块式管理
  - 伙伴系统算法：按照2的幂划分块，每次找能满足需求的最小块；连续的是伙伴，可以再分，解决外部内存碎片
- 非连续内存管理：进程使用的内存空间可以不连续
  - 段式
  - 页式
  - 段页式

### 使用虚拟内存的优点

作用：作为进程访问物理内存的一个桥梁，简化内存管理

优点：

- 隔离进程，安全：每个进程对应一个虚拟地址空间，通过虚拟地址空间映射到物理内存，无法直接操作别的进程的物理内存，彼此隔离
- 简化内存管理：开发时统一访问虚拟地址空间，操作统一
- 提高物理内存利用率
  - 共享物理内存：物理内存中只用存一份操作系统的动态库，每个进程共享
  - 选择加载：正在使用的部分加载到物理内存，不用的可以放到磁盘
- 更大内存空间：物理内存不够时，可以用磁盘充当

### 虚拟地址和物理地址的映射

使用CPU里的MMU（Memory Management Unit）进行地址转换

物理内存的分配机制不同，映射方式也不同：

- 分段：段的大小不相等，段是逻辑单位；存在外部内存碎片
- 分页：页的大小相等
  - 页表
    - 页缺失：
      - 硬性页缺失：物理内存中没有对应物理页（换出去了）
      - 软性页缺失：物理内存中有对应物理页，但还没和虚拟页建立映射（页表项还不存在）
    - 多级页表：时间换空间，利用增加页表查询的次数减少页表占用的空间
    - TLB（**Translation Lookaside Buffer**）：快表，页表的缓存，提高转换速度；高速缓存
- 段页

### 页面置换算法

页面置换=换页机制：物理内存不够时，操作系统将一些物理页的内容放到磁盘上去；淘汰物理内存页的规则

常见的页面置换算法

- OPT：理想算法，不可实现
- FIFO：先进先出
- LRU：最近最久未使用；最接近OPT的
- LFU：最少使用

## 文件系统

CPU缓存-内存（虚拟内存空间-物理内存）-硬盘

### 文件系统

每个文件和目录都有一个唯一的索引节点（inode）号，用来标识该文件或目录

每个文件系统都有自己的独立 inode 表，维护自己文件系统内的inode节点号

Inode表中存储

- inode号码
- 指针：指向文件的数据存储位置

### 文件链接

文件链接（File Link）是一种特殊的文件类型

#### 硬连接

- `ln` 命令创建
- 硬链接和源文件的 inode 节点号相同，两者平等
- 不能对目录以及不存在的文件创建硬链接
- 不能跨越文件系统
- 作用：删除其中任何一个对另外一个没有影响，可以通过给文件设置硬链接文件来防止重要文件被误删；只有两个都删除才是真的删除

#### 软连接

- `ln -s` 命令创建
- 软链接和源文件的 inode 节点号不同，而是指向一个文件路径
- 相当于快捷方式
- 可以对目录以及不存在的文件创建硬链接
- 可以跨越文件系统